<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Investigation Console
  </title>
  <!-- Brand Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" referrerpolicy="no-referrer" rel="stylesheet"/>
  <!-- Leaflet CSS for Geo Map -->
  <link crossorigin="" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" rel="stylesheet"/>
  <!-- Global Theme CSS -->
  <link href="style.css" rel="stylesheet"/>
  <!-- Page-specific CSS -->
  <link href="investigation_console.css" rel="stylesheet"/>
 </head>
 <body>
  <!-- Header (Common Component - needed on this page) -->
  <header class="navbar navbar-expand-lg navbar-dark" style="background-color:#2563EB;">
   <div class="container-fluid">
    <button aria-controls="sidebarMain" class="btn btn-outline-light me-2 d-lg-none" id="sidebarToggleBtn" type="button">
     <i class="fas fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./investigation_console.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/56/56'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68b23c2b8ecfc2752de0c99b/logos/logo_6f951f7f-9970-428c-b8fb-4f73719ce057.png" style="height:28px;"/>
     <span>
      Investigation Console
     </span>
    </a>
    <form class="d-none d-md-flex mx-auto" role="search" style="max-width: 420px;">
     <input aria-label="Search" class="form-control form-control-sm" id="globalSearch" placeholder="Quick search IPs, users, hosts" type="search"/>
    </form>
    <ul class="navbar-nav ms-auto align-items-center">
     <li class="nav-item me-2 d-none d-md-block">
      <button class="btn btn-sm btn-warning text-dark" id="newQueryBtn">
       <i class="fas fa-plus me-1">
       </i>
       New Query
      </button>
     </li>
     <li class="nav-item me-2 d-none d-md-block">
      <button class="btn btn-sm btn-outline-light" id="clearSessionBtn">
       <i class="fas fa-eraser me-1">
       </i>
       Clear Session
      </button>
     </li>
     <li class="nav-item dropdown me-2">
      <a aria-expanded="false" class="nav-link" data-bs-toggle="dropdown" href="#" id="alertsDropdown" role="button">
       <i class="fas fa-bell">
       </i>
       <span class="badge bg-warning text-dark ms-1">
        3
       </span>
      </a>
      <ul aria-labelledby="alertsDropdown" class="dropdown-menu dropdown-menu-end">
       <li class="dropdown-header">
        Notifications
       </li>
       <li>
        <a class="dropdown-item" href="#">
         New critical alert spike detected
        </a>
       </li>
       <li>
        <a class="dropdown-item" href="#">
         Playbook execution completed
        </a>
       </li>
      </ul>
     </li>
     <li class="nav-item me-2 d-none d-md-block">
      <a class="nav-link" href="#">
       <i class="fas fa-envelope">
       </i>
      </a>
     </li>
     <li class="nav-item dropdown">
      <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#" id="userMenu" role="button">
       <img alt="avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/avatar/48/48'" src="https://www.gravatar.com/avatar?d=mp" style="width:24px;height:24px;"/>
       <span id="userNameTop">
        {{UserName}}
       </span>
      </a>
      <ul aria-labelledby="userMenu" class="dropdown-menu dropdown-menu-end">
       <li class="dropdown-header" id="userRoleTop">
        {{UserRole}}
       </li>
       <li>
        <a class="dropdown-item" href="./admin_settings.html">
         <i class="fas fa-cog me-2">
         </i>
         Settings
        </a>
       </li>
       <li>
        <a class="dropdown-item" href="#keyboard">
         <i class="fas fa-keyboard me-2">
         </i>
         Keyboard Shortcuts
        </a>
       </li>
       <li>
        <hr class="dropdown-divider"/>
       </li>
       <li>
        <a class="dropdown-item" href="./login_page.html">
         <i class="fas fa-sign-out-alt me-2">
         </i>
         Logout
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </div>
  </header>
  <!-- Main Layout -->
  <div class="d-flex">
   <!-- Sidebar (Common Component - needed on this page) -->
   <aside class="d-flex flex-column flex-shrink-0 bg-light border-end" id="sidebarMain" style="width: 280px; min-height: 100vh;">
    <div class="p-3 border-bottom d-flex align-items-center">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/64/64'" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68b23c2b8ecfc2752de0c99b/logos/logo_6f951f7f-9970-428c-b8fb-4f73719ce057.png" style="height:32px;"/>
     <div>
      <div class="fw-semibold" style="color:#2563EB;">
       Analyst Workspace
      </div>
      <small class="text-muted">
       SOC Analyst / Responder
      </small>
     </div>
    </div>
    <div class="px-3 py-3 border-bottom">
     <div class="d-flex align-items-center">
      <img alt="avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/user/72/72'" src="https://www.gravatar.com/avatar?d=mp" style="width:36px;height:36px;"/>
      <div>
       <div class="fw-semibold" id="sidebarUserName">
        {{UserName}}
       </div>
       <small class="text-muted" id="sidebarUserRole">
        {{UserRole}}
       </small>
      </div>
     </div>
    </div>
    <nav class="flex-grow-1 overflow-auto pt-2">
     <ul class="nav nav-pills flex-column mb-auto" id="analystNav">
      <li class="nav-item">
       <a class="nav-link active d-flex align-items-center" href="./investigation_console.html">
        <i class="fas fa-terminal me-2">
        </i>
        Investigation Console
       </a>
      </li>
      <li>
       <a aria-controls="investigateMenu" aria-expanded="true" class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#investigateMenu" role="button">
        <i class="fas fa-search me-2">
        </i>
        Investigations
        <i class="fas fa-chevron-down ms-auto small">
        </i>
       </a>
       <div class="collapse show ps-4" id="investigateMenu">
        <ul class="nav flex-column">
         <li>
          <a class="nav-link" href="#recent">
           <i class="fas fa-history me-2">
           </i>
           Recent Queries
          </a>
         </li>
         <li>
          <a class="nav-link" href="#saved">
           <i class="fas fa-bookmark me-2">
           </i>
           Saved Searches
          </a>
         </li>
         <li>
          <a class="nav-link" href="#entities">
           <i class="fas fa-user-secret me-2">
           </i>
           Entities
          </a>
         </li>
        </ul>
       </div>
      </li>
      <li>
       <a aria-controls="vizMenu" aria-expanded="false" class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#vizMenu" role="button">
        <i class="fas fa-chart-line me-2">
        </i>
        Visualizations
        <i class="fas fa-chevron-down ms-auto small">
        </i>
       </a>
       <div class="collapse ps-4" id="vizMenu">
        <ul class="nav flex-column">
         <li>
          <a class="nav-link" href="#tables">
           <i class="fas fa-table me-2">
           </i>
           Tables
          </a>
         </li>
         <li>
          <a class="nav-link" href="#timeseries">
           <i class="fas fa-chart-area me-2">
           </i>
           Time Series
          </a>
         </li>
         <li>
          <a class="nav-link" href="#geomap">
           <i class="fas fa-globe me-2">
           </i>
           Geo-Map
          </a>
         </li>
        </ul>
       </div>
      </li>
      <li>
       <a aria-controls="actionsMenu" aria-expanded="false" class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#actionsMenu" role="button">
        <i class="fas fa-bolt me-2">
        </i>
        Response Actions
        <i class="fas fa-chevron-down ms-auto small">
        </i>
       </a>
       <div class="collapse ps-4" id="actionsMenu">
        <ul class="nav flex-column">
         <li>
          <a class="nav-link" href="#playbooks">
           <i class="fas fa-clipboard-list me-2">
           </i>
           SOAR Playbooks
          </a>
         </li>
         <li>
          <a class="nav-link" href="#blocklist">
           <i class="fas fa-shield-alt me-2">
           </i>
           Blocklist
          </a>
         </li>
        </ul>
       </div>
      </li>
     </ul>
    </nav>
    <div class="mt-auto p-3 border-top small">
     <div class="d-flex justify-content-between">
      <a class="text-decoration-none" href="#shortcuts">
       <i class="fas fa-keyboard me-1" style="color:#F59E0B;">
       </i>
       Shortcuts
      </a>
      <a class="text-decoration-none" href="#help">
       <i class="fas fa-question-circle me-1" style="color:#F59E0B;">
       </i>
       Help
      </a>
     </div>
    </div>
    <style>
     #sidebarMain .nav-link { color:#374151; border-radius:.375rem; }
        #sidebarMain .nav-link:hover { background-color: rgba(37,99,235,.08); color:#111827; }
        #sidebarMain .nav-link.active { background-color: rgba(37,99,235,.12); color:#2563EB; font-weight:600; }
        #sidebarMain .nav .collapse .nav-link { padding-left: .75rem; }
    </style>
   </aside>
   <!-- Main Content Area -->
   <main class="flex-grow-1">
    <div class="container-fluid py-3">
     <!-- Top breadcrumb and quick nav -->
     <nav aria-label="breadcrumb" class="breadcrumb">
      <ol class="breadcrumb mb-2">
       <li class="breadcrumb-item">
        <a href="./investigation_console.html">
         Home
        </a>
       </li>
       <li aria-current="page" class="breadcrumb-item active">
        Investigation Console
       </li>
      </ol>
     </nav>
     <!-- System connection alert -->
     <div class="alert alert-info d-flex align-items-center" role="alert">
      <i class="fas fa-plug me-2">
      </i>
      Connected to SIEM: Elastic (last sync:
      <span class="fw-semibold" id="lastSyncTs">
       just now
      </span>
      )
      <button class="btn btn-sm btn-light ms-auto" id="refreshConnection">
       <i class="fas fa-rotate me-1">
       </i>
       Refresh
      </button>
     </div>
     <div class="row g-3">
      <!-- Chat Interface -->
      <div class="col-12 col-xl-5">
       <div class="card h-100 chat-panel d-flex flex-column">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fas fa-terminal text-primary">
          </i>
          <span class="widget-title">
           Investigation Chat
          </span>
         </div>
         <div class="d-flex align-items-center gap-2">
          <span class="badge bg-primary-soft text-primary border">
           Session:
           <span class="ms-1" id="sessionIdLabel">
           </span>
          </span>
          <button class="btn btn-sm btn-light" id="openHistoryBtn">
           <i class="fas fa-clock-rotate-left me-1">
           </i>
           History
          </button>
         </div>
        </div>
        <div class="card-body conversation-log overflow-auto" id="conversationLog">
         <!-- Sample conversation -->
         <div class="message-list">
          <div class="message-row incoming">
           <div class="message-bubble">
            <div class="message-text">
             Welcome! Ask me about suspicious activity, e.g., Show failed logins from 10.1.2.0/24 in last 24h.
            </div>
            <div class="message-metadata mt-1">
             System •
             <span>
              Now
             </span>
            </div>
           </div>
          </div>
         </div>
        </div>
        <div class="card-footer p-2">
         <form class="message-input-bar" id="queryForm">
          <div class="flex-grow-1">
           <textarea aria-label="Natural language query" class="form-control form-control-sm" id="queryText" placeholder="Type a query... (Enter to submit, Shift+Enter for new line)" rows="2"></textarea>
          </div>
          <button class="btn btn-primary" disabled="" id="submitQueryBtn" type="submit">
           <i class="fas fa-paper-plane">
           </i>
          </button>
         </form>
        </div>
       </div>
      </div>
      <!-- Results and Visualizations -->
      <div class="col-12 col-xl-7">
       <div class="card h-100 d-flex flex-column">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fas fa-table text-primary">
          </i>
          <span class="widget-title">
           Query Results
          </span>
         </div>
         <div class="d-flex align-items-center gap-2">
          <div class="view-switcher d-none d-md-inline-flex">
           <div class="option active" data-view="table">
            <i class="fas fa-table me-1">
            </i>
            Table
           </div>
           <div class="option" data-view="viz">
            <i class="fas fa-chart-line me-1">
            </i>
            Visual
           </div>
          </div>
          <button class="btn btn-sm btn-light" id="exportCsvBtn">
           <i class="fas fa-file-export me-1">
           </i>
           Export CSV
          </button>
         </div>
        </div>
        <div class="card-body p-0 d-flex flex-column">
         <!-- Filters -->
         <div class="p-3 border-bottom bg-light">
          <div class="row g-2 align-items-end">
           <div class="col-md-3">
            <label class="form-label mb-1">
             Search
            </label>
            <input class="form-control form-control-sm" id="tableSearch" placeholder="IP, user, host..." type="text"/>
           </div>
           <div class="col-md-3">
            <label class="form-label mb-1">
             Severity
            </label>
            <select class="form-select form-select-sm" id="severityFilter">
             <option value="">
              All
             </option>
             <option value="Critical">
              Critical
             </option>
             <option value="High">
              High
             </option>
             <option value="Medium">
              Medium
             </option>
             <option value="Low">
              Low
             </option>
            </select>
           </div>
           <div class="col-md-3">
            <label class="form-label mb-1">
             Time Range
            </label>
            <select class="form-select form-select-sm" id="timeRange">
             <option value="24h">
              Last 24h
             </option>
             <option value="7d">
              Last 7d
             </option>
             <option value="30d">
              Last 30d
             </option>
            </select>
           </div>
           <div class="col-md-3">
            <button class="btn btn-sm btn-primary w-100" id="applyFiltersBtn">
             <i class="fas fa-filter me-1">
             </i>
             Apply
            </button>
           </div>
          </div>
         </div>
         <!-- TABLE VIEW -->
         <div class="flex-grow-1 d-flex flex-column" id="tableView">
          <div class="table-responsive">
           <table class="table table-theme mb-0" id="resultsTable">
            <thead>
             <tr>
              <th data-sort="timestamp" role="button">
               Timestamp
               <i class="fas fa-sort text-muted">
               </i>
              </th>
              <th data-sort="ip" role="button">
               Source IP
               <i class="fas fa-sort text-muted">
               </i>
              </th>
              <th data-sort="user" role="button">
               User
               <i class="fas fa-sort text-muted">
               </i>
              </th>
              <th data-sort="host" role="button">
               Host
               <i class="fas fa-sort text-muted">
               </i>
              </th>
              <th data-sort="event" role="button">
               Event
               <i class="fas fa-sort text-muted">
               </i>
              </th>
              <th data-sort="severity" role="button">
               Severity
               <i class="fas fa-sort text-muted">
               </i>
              </th>
              <th>
               Action
              </th>
             </tr>
            </thead>
            <tbody>
             <!-- Rows injected by JS -->
            </tbody>
           </table>
          </div>
          <div class="d-flex align-items-center justify-content-between p-2 border-top bg-light small">
           <div>
            Showing
            <span id="showingCount">
             0
            </span>
            of
            <span id="totalCount">
             0
            </span>
            results
           </div>
           <nav>
            <ul class="pagination pagination-sm mb-0" id="tablePagination">
             <li class="page-item">
              <a class="page-link" data-page="prev" href="#">
               Prev
              </a>
             </li>
             <!-- page numbers injected by JS -->
             <li class="page-item">
              <a class="page-link" data-page="next" href="#">
               Next
              </a>
             </li>
            </ul>
           </nav>
          </div>
         </div>
         <!-- VISUAL VIEW -->
         <div class="flex-grow-1 d-none" id="vizView">
          <div class="p-3">
           <ul class="nav nav-tabs" id="vizTabs" role="tablist">
            <li class="nav-item" role="presentation">
             <button aria-controls="ts-pane" aria-selected="true" class="nav-link active" data-bs-target="#ts-pane" data-bs-toggle="tab" id="ts-tab" role="tab" type="button">
              <i class="fas fa-chart-line me-1">
              </i>
              Time Series
             </button>
            </li>
            <li class="nav-item" role="presentation">
             <button aria-controls="map-pane" aria-selected="false" class="nav-link" data-bs-target="#map-pane" data-bs-toggle="tab" id="map-tab" role="tab" type="button">
              <i class="fas fa-globe me-1">
              </i>
              Geo Map
             </button>
            </li>
           </ul>
           <div class="tab-content pt-3">
            <div aria-labelledby="ts-tab" class="tab-pane fade show active" id="ts-pane" role="tabpanel">
             <canvas height="160" id="timeSeriesChart">
             </canvas>
            </div>
            <div aria-labelledby="map-tab" class="tab-pane fade" id="map-pane" role="tabpanel">
             <div class="rounded border" id="geoMap" style="height: 320px;">
             </div>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <!-- Session History Offcanvas/Drawer -->
  <div aria-labelledby="historyDrawerLabel" class="offcanvas offcanvas-end" id="historyDrawer" tabindex="-1">
   <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="historyDrawerLabel">
     <i class="fas fa-clock-rotate-left me-2">
     </i>
     Session History
    </h5>
    <button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button">
    </button>
   </div>
   <div class="offcanvas-body">
    <div class="list-group" id="historyList">
     <!-- History items injected by JS -->
    </div>
   </div>
  </div>
  <!-- Footer (Common Component - needed on this page) -->
  <footer class="border-top py-2 px-3 d-flex flex-wrap align-items-center justify-content-between bg-light">
   <div class="d-flex align-items-center">
    <span class="badge me-2" style="background-color:#2563EB;">
     Analyst
    </span>
    <small class="text-muted">
     Tip: Press Enter to submit queries. Use Shift+Enter for new line.
    </small>
   </div>
   <div class="small d-flex align-items-center gap-3 flex-wrap">
    <a class="text-decoration-none" href="#terms">
     Terms
    </a>
    <a class="text-decoration-none" href="#privacy">
     Privacy
    </a>
    <button class="btn btn-sm btn-outline-primary" id="newIncidentBtn">
     <i class="fas fa-flag me-1" style="color:#F59E0B;">
     </i>
     New Incident
    </button>
    <span class="text-muted">
     Navigate:
     <a class="ms-1 me-2" href="./login_page.html">
      Login
     </a>
     |
     <a class="mx-2" href="./investigation_console.html">
      Investigation
     </a>
     |
     <a class="mx-2" href="./performance_dashboard.html">
      Performance
     </a>
     |
     <a class="mx-2" href="./audit_log.html">
      Audit Log
     </a>
     |
     <a class="mx-2" href="./admin_settings.html">
      Admin
     </a>
    </span>
   </div>
  </footer>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>
  <!-- Bootstrap 5 Bundle -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js">
  </script>
  <!-- Leaflet JS -->
  <script crossorigin="" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>
  <script>
   // Basic State
const state = {
    currentUser: {
        name: 'Alex Johnson',
        role: 'SOC Analyst'
    },
    sessionID: Math.random().toString(36).slice(2, 8).toUpperCase(),
    isLoading: false,
    conversationHistory: [],
    results: [],
    filteredResults: [],
    sort: {
        key: 'timestamp',
        dir: 'desc'
    },
    pagination: {
        page: 1,
        pageSize: 6
    },
    view: 'table',
    history: []
};

// Sample Mock Data Generator
const mockRows = [{
    timestamp: '2025-08-30 10:23:45',
    ip: '185.199.110.153',
    user: 'svc-backup',
    host: 'srv-files-01',
    event: 'Failed Login',
    severity: 'Medium'
}, {
    timestamp: '2025-08-30 10:21:02',
    ip: '45.83.21.14',
    user: 'jsmith',
    host: 'laptop-238',
    event: 'MFA Bypass Attempt',
    severity: 'High'
}, {
    timestamp: '2025-08-30 10:11:17',
    ip: '10.1.2.44',
    user: 'svc-api',
    host: 'web-02',
    event: 'API Rate Spike',
    severity: 'Low'
}, {
    timestamp: '2025-08-30 09:59:51',
    ip: '77.88.21.8',
    user: 'ngupta',
    host: 'wrk-773',
    event: 'Suspicious PowerShell',
    severity: 'Critical'
}, {
    timestamp: '2025-08-30 09:55:10',
    ip: '192.168.5.77',
    user: 'svc-db',
    host: 'db-prod-01',
    event: 'Multiple Login Failures',
    severity: 'Medium'
}, {
    timestamp: '2025-08-30 09:50:27',
    ip: '203.0.113.24',
    user: 'mmartin',
    host: 'wrk-130',
    event: 'Malware Detection',
    severity: 'High'
}, {
    timestamp: '2025-08-30 09:44:33',
    ip: '198.51.100.7',
    user: 'svc-etl',
    host: 'etl-01',
    event: 'Data Exfiltration Alert',
    severity: 'Critical'
}, {
    timestamp: '2025-08-30 09:40:00',
    ip: '10.1.2.101',
    user: 'jsmith',
    host: 'laptop-238',
    event: 'Brute Force Detected',
    severity: 'High'
}, {
    timestamp: '2025-08-30 09:38:21',
    ip: '192.0.2.55',
    user: 'svc-web',
    host: 'web-01',
    event: '403 Spike',
    severity: 'Low'
}, {
    timestamp: '2025-08-30 09:30:44',
    ip: '62.16.9.155',
    user: 'hkim',
    host: 'wrk-411',
    event: 'Suspicious Process',
    severity: 'Medium'
}];

function initUser() {
    document.getElementById('userNameTop').textContent = state.currentUser.name;
    document.getElementById('userRoleTop').textContent = state.currentUser.role;
    document.getElementById('sidebarUserName').textContent = state.currentUser.name;
    document.getElementById('sidebarUserRole').textContent = state.currentUser.role;
    document.getElementById('sessionIdLabel').textContent = state.sessionID;
}

function setSubmitEnabled() {
    const txt = document.getElementById('queryText');
    const btn = document.getElementById('submitQueryBtn');
    btn.disabled = state.isLoading || !txt.value.trim();
}

function addMessage(author, content, type, extra = {}) {
    const log = document.querySelector('#conversationLog .message-list');
    const row = document.createElement('div');
    row.className = 'message-row ' + (author === 'user' ? 'outgoing' : 'incoming');
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';

    const textDiv = document.createElement('div');
    textDiv.className = 'message-text';
    textDiv.textContent = content;
    bubble.appendChild(textDiv);

    if (type === 'translated_query' && extra.querySyntax) {
        const pre = document.createElement('pre');
        pre.className = 'bg-light border rounded p-2 mt-2';
        pre.style.whiteSpace = 'pre-wrap';
        pre.textContent = extra.querySyntax;
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-sm btn-light mt-2';
        copyBtn.innerHTML = '<i class="fas fa-copy me-1"></i> Copy SIEM Query';
        copyBtn.addEventListener('click', async () => {
            await navigator.clipboard.writeText(extra.querySyntax);
            Swal.fire({
                icon: 'success',
                title: 'Copied',
                text: 'Query copied to clipboard',
                timer: 1200,
                showConfirmButton: false
            });
        });
        bubble.appendChild(pre);
        bubble.appendChild(copyBtn);
    }

    const meta = document.createElement('div');
    meta.className = 'message-metadata mt-1';
    meta.textContent = (author === 'user' ? 'You' : 'System') + ' • ' + new Date().toLocaleTimeString();
    bubble.appendChild(meta);

    row.appendChild(bubble);
    log.appendChild(row);
    log.parentElement.scrollTop = log.parentElement.scrollHeight;
}

// Loading indicator in chat
let loadingEl = null;

function showLoading(active) {
    const logWrap = document.querySelector('#conversationLog .message-list');
    if (active) {
        loadingEl = document.createElement('div');
        loadingEl.className = 'message-row incoming';
        const b = document.createElement('div');
        b.className = 'message-bubble';
        b.innerHTML = '<div class="skeleton" style="height: 48px; width: 240px;"></div>';
        loadingEl.appendChild(b);
        logWrap.appendChild(loadingEl);
        logWrap.parentElement.scrollTop = logWrap.parentElement.scrollHeight;
    } else {
        if (loadingEl) loadingEl.remove();
        loadingEl = null;
    }
}

// Table Rendering
function severityBadge(sev) {
    const color = {
        Critical: 'danger',
        High: 'warning',
        Medium: 'secondary',
        Low: 'info'
    } [sev] || 'secondary';
    return `<span class="badge bg-${color}">${sev}</span>`;
}

function renderTable() {
    const tbody = document.querySelector('#resultsTable tbody');
    tbody.innerHTML = '';

    // sort
    const {
        key,
        dir
    } = state.sort;
    const sorted = [...state.filteredResults].sort((a, b) => {
        let va = a[key],
            vb = b[key];
        if (key === 'timestamp') {
            va = new Date(va).getTime();
            vb = new Date(vb).getTime();
        }
        if (va < vb) return dir === 'asc' ? -1 : 1;
        if (va > vb) return dir === 'asc' ? 1 : -1;
        return 0;
    });

    // pagination
    const {
        page,
        pageSize
    } = state.pagination;
    const total = sorted.length;
    const start = (page - 1) * pageSize;
    const paged = sorted.slice(start, start + pageSize);

    paged.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-nowrap">${r.timestamp}</td>
          <td>${r.ip}</td>
          <td>${r.user}</td>
          <td>${r.host}</td>
          <td>${r.event}</td>
          <td>${severityBadge(r.severity)}</td>
          <td>
            ${['High', 'Critical'].includes(r.severity) ? `<button class="btn btn-sm btn-outline-danger" data-action="block-ip" data-entity="${r.ip}"><i class="fas fa-shield-halved me-1"></i>Block IP</button>` : ''}
          </td>
        `;
        tbody.appendChild(tr);
    });

    // Action handlers
    tbody.querySelectorAll('button[data-action="block-ip"]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
            const ip = e.currentTarget.getAttribute('data-entity');
            confirmAction('Block IP', `Are you sure you want to block IP ${ip}?`, () => {
                Swal.fire({
                    icon: 'success',
                    title: 'Action executed',
                    text: `SOAR playbook triggered to block ${ip}`
                });
            });
        });
    });

    // counts
    document.getElementById('totalCount').textContent = total;
    document.getElementById('showingCount').textContent = paged.length;

    renderPagination(total);
}

function renderPagination(total) {
    const ul = document.getElementById('tablePagination');
    // clear number items
    ul.querySelectorAll('li.page-number').forEach((li) => li.remove());

    const pages = Math.max(1, Math.ceil(total / state.pagination.pageSize));
    const current = state.pagination.page;
    const nextLi = ul.querySelector('a[data-page="next"]').parentElement;
    const prevLi = ul.querySelector('a[data-page="prev"]').parentElement;

    // insert page numbers before next
    for (let i = 1; i <= pages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item page-number ' + (i === current ? 'active' : '');
        li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        ul.insertBefore(li, nextLi);
    }

    // enable/disable prev/next
    prevLi.classList.toggle('disabled', current === 1);
    nextLi.classList.toggle('disabled', current === pages);

    ul.querySelectorAll('a.page-link').forEach((a) => {
        a.addEventListener('click', (e) => {
            e.preventDefault();
            const p = a.getAttribute('data-page');
            const pages2 = Math.max(1, Math.ceil(total / state.pagination.pageSize));
            if (p === 'prev') {
                if (state.pagination.page > 1) state.pagination.page--;
            } else if (p === 'next') {
                if (state.pagination.page < pages2) state.pagination.page++;
            } else {
                state.pagination.page = parseInt(p, 10);
            }
            renderTable();
        });
    });
}

function applyFilters() {
    const q = document.getElementById('tableSearch').value.trim().toLowerCase();
    const sev = document.getElementById('severityFilter').value;
    state.filteredResults = state.results.filter((r) => {
        const matchesSev = !sev || r.severity === sev;
        const hay = `${r.timestamp} ${r.ip} ${r.user} ${r.host} ${r.event}`.toLowerCase();
        const matchesQ = !q || hay.includes(q);
        return matchesSev && matchesQ;
    });
    state.pagination.page = 1;
    renderTable();
}

function wireTableSort() {
    document.querySelectorAll('#resultsTable thead th[data-sort]').forEach((th) => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort');
            if (state.sort.key === key) {
                state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                state.sort.key = key;
                state.sort.dir = 'asc';
            }
            renderTable();
        });
    });
}

// View switcher
function wireViewSwitcher() {
    document.querySelectorAll('.view-switcher .option').forEach((opt) => {
        opt.addEventListener('click', () => {
            document.querySelectorAll('.view-switcher .option').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            state.view = opt.getAttribute('data-view');
            document.getElementById('tableView').classList.toggle('d-none', state.view !== 'table');
            document.getElementById('vizView').classList.toggle('d-none', state.view !== 'viz');
            if (state.view === 'viz') {
                setTimeout(() => {
                    timeSeriesChart && timeSeriesChart.update();
                    if (map) setTimeout(() => map.invalidateSize(), 250);
                }, 150);
            }
        });
    });
}

// SweetAlert2 confirm
function confirmAction(title, text, onConfirm) {
    Swal.fire({
        title,
        text,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#2563EB',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Confirm'
    }).then((result) => {
        if (result.isConfirmed) onConfirm && onConfirm();
    });
}

// Charts
let timeSeriesChart = null;

function initCharts() {
    const ctx = document.getElementById('timeSeriesChart');
    timeSeriesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['-5h', '-4h', '-3h', '-2h', '-1h', 'Now'],
            datasets: [{
                label: 'Event Count',
                data: [42, 58, 63, 51, 70, 82],
                borderColor: '#2563EB',
                backgroundColor: 'rgba(37,99,235,0.1)',
                tension: 0.3,
                fill: true,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    enabled: true
                }
            }
        }
    });
}

// Leaflet Map
let map = null;

function initMap() {
    map = L.map('geoMap').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    // mock markers
    const points = [{
        lat: 37.7749,
        lng: -122.4194,
        label: 'San Francisco - 185.199.110.153'
    }, {
        lat: 40.7128,
        lng: -74.0060,
        label: 'New York - 45.83.21.14'
    }, {
        lat: 51.5074,
        lng: -0.1278,
        label: 'London - 77.88.21.8'
    }, {
        lat: 28.6139,
        lng: 77.2090,
        label: 'Delhi - 62.16.9.155'
    }];
    points.forEach(p => L.marker([p.lat, p.lng]).addTo(map).bindTooltip(p.label));
    setTimeout(() => map.invalidateSize(), 250);
}

// History Drawer
function renderHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    if (state.history.length === 0) {
        list.innerHTML = '<div class="text-muted">No history yet</div>';
        return;
    }
    state.history.forEach((h, idx) => {
        const a = document.createElement('button');
        a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-start';
        a.innerHTML = `<div><div class="fw-semibold">${h.query}</div><small class="text-muted">${h.time}</small></div><span class="badge bg-primary-soft text-primary border">${h.count} rows</span>`;
        a.addEventListener('click', () => {
            // Load results from history (mock uses same dataset)
            state.results = h.results;
            applyFilters();
            document.querySelector('.view-switcher .option[data-view="table"]').click();
            const off = bootstrap.Offcanvas.getInstance(document.getElementById('historyDrawer'));
            off && off.hide();
            addMessage('system', 'Loaded results from history.', 'result_summary');
        });
        list.appendChild(a);
    });
}

// Export CSV
function exportCSV() {
    const header = ['timestamp', 'ip', 'user', 'host', 'event', 'severity'];
    const rows = state.filteredResults.map(r => header.map(h => '"' + String(r[h]).replace(/"/g, '\"') + '"').join(','));
    const csv = [header.join(','), ...rows].join('\n');
    const blob = new Blob([csv], {
        type: 'text/csv;charset=utf-8;'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'query_results.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
}

// Sidebar mobile toggle (since provided sidebar is not Bootstrap offcanvas)
function wireSidebarMobile() {
    const btn = document.getElementById('sidebarToggleBtn');
    const sidebar = document.getElementById('sidebarMain');
    btn.addEventListener('click', () => {
        sidebar.classList.toggle('mobile-open');
    });
    // close when clicking outside
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebarMain');
        const btn = document.getElementById('sidebarToggleBtn');
        if (!sidebar.contains(e.target) && !btn.contains(e.target)) {
            sidebar.classList.remove('mobile-open');
        }
    });
}

function wireHeaderButtons() {
    document.getElementById('newQueryBtn').addEventListener('click', () => {
        document.getElementById('queryText').focus();
    });
    document.getElementById('clearSessionBtn').addEventListener('click', () => {
        confirmAction('Clear session', 'This will clear chat history and results.', () => {
            state.conversationHistory = [];
            document.querySelector('#conversationLog .message-list').innerHTML = '';
            addMessage('system', 'Session cleared. You can start a new investigation.', 'result_summary');
            state.results = [];
            state.filteredResults = [];
            renderTable();
            state.history = [];
            renderHistory();
        });
    });
    document.getElementById('newIncidentBtn').addEventListener('click', () => {
        Swal.fire({
            title: 'Create Incident',
            input: 'text',
            inputLabel: 'Incident Title',
            showCancelButton: true,
            confirmButtonText: 'Create'
        }).then(res => {
            if (res.isConfirmed) Swal.fire({
                icon: 'success',
                title: 'Incident created',
                text: `"${res.value}" has been created.`
            });
        });
    });
    document.getElementById('refreshConnection').addEventListener('click', () => {
        const btn = document.getElementById('refreshConnection');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-rotate me-1 fa-spin"></i>Refreshing';
        setTimeout(() => {
            document.getElementById('lastSyncTs').textContent = 'a moment ago';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rotate me-1"></i>Refresh';
            Swal.fire({
                icon: 'success',
                title: 'Connection refreshed',
                timer: 1000,
                showConfirmButton: false
            });
        }, 1000);
    });
}

function wireHistoryDrawer() {
    const openBtn = document.getElementById('openHistoryBtn');
    const off = new bootstrap.Offcanvas('#historyDrawer');
    openBtn.addEventListener('click', () => {
        renderHistory();
        off.show();
    });
}

function wireQueryForm() {
    const txt = document.getElementById('queryText');
    const form = document.getElementById('queryForm');
    txt.addEventListener('input', setSubmitEnabled);
    txt.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.requestSubmit();
        }
    });
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const query = txt.value.trim();
        if (!query) return;
        state.isLoading = true;
        setSubmitEnabled();
        addMessage('user', query, 'query');
        showLoading(true);
        // Simulate NLP translation and result fetch
        setTimeout(() => {
            showLoading(false);
            state.isLoading = false;
            setSubmitEnabled();
            const translated = `index=security sourcetype=auth action=failure src=${query.includes('10.1.2') ? '10.1.2.0/24' : '*'} earliest=-24h latest=now | stats count by src, user, host | sort -count`;
            addMessage('system', 'Translated SIEM query for verification:', 'translated_query', {
                querySyntax: translated
            });
            addMessage('system', 'Fetched results. See the table and visualizations.', 'result_summary');
            // Load mock data to results
            state.results = [...mockRows];
            applyFilters();
            // Update history
            state.history.unshift({
                query,
                time: new Date().toLocaleString(),
                count: state.results.length,
                results: [...state.results]
            });
            renderHistory();
            // Switch to table view automatically
            document.querySelector('.view-switcher .option[data-view="table"]').click();
            // Update charts with small randomization
            if (timeSeriesChart) {
                timeSeriesChart.data.datasets[0].data = [42, 58, 63, 51, 70, 82].map(v => v + Math.floor(Math.random() * 10 - 5));
                timeSeriesChart.update();
            }
        }, 1400);
        txt.value = '';
    });
}

function wireFiltersAndExport() {
    document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    initUser();
    state.results = [...mockRows];
    state.filteredResults = [...state.results];
    wireTableSort();
    renderTable();
    wireViewSwitcher();
    initCharts();
    initMap();
    wireSidebarMobile();
    wireHeaderButtons();
    wireHistoryDrawer();
    wireQueryForm();
    wireFiltersAndExport();
    setSubmitEnabled();
});
  </script>
 </body>
</html>
